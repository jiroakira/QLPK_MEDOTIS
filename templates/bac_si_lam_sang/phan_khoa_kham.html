{% extends 'base.html' %} {% load static %} {% block content %}

<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
  <!--begin::Subheader-->
  <div class="subheader py-2 py-lg-6 subheader-solid" id="kt_subheader">
    <div
      class="
        container-fluid
        d-flex
        align-items-center
        justify-content-between
        flex-wrap flex-sm-nowrap
      "
    >
      <!--begin::Info-->
      <div class="d-flex align-items-center flex-wrap mr-1">
        <!--begin::Page Heading-->
        <div class="d-flex align-items-baseline flex-wrap mr-5">
          <!--begin::Page Title-->
          <h5 class="text-dark font-weight-bold my-1 mr-5">Bác Sĩ Lâm Sàng</h5>
          <!--end::Page Title-->
          <!--begin::Breadcrumb-->
          <ul
            class="
              breadcrumb breadcrumb-transparent breadcrumb-dot
              font-weight-bold
              p-0
              my-2
              font-size-sm
            "
          >
            <li class="breadcrumb-item">
              <a href="javascript:;" class="text-muted"
                >Bệnh Nhân: {{ benh_nhan.ho_ten }}</a
              >
            </li>
            <li class="breadcrumb-item">
              <a href="javascript:;" class="text-muted">Phân khoa khám</a>
            </li>
          </ul>
          <!--end::Breadcrumb-->
        </div>
        <!--end::Page Heading-->
      </div>
      <!--end::Info-->
    </div>
  </div>
  <!--end::Subheader-->

  <!--begin::Entry-->
  <div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container">
      <!--begin::Card-->
      <div class="card card-custom">
        <div class="card-header flex-wrap border-0 pt-6 pb-0">
          <div class="card-title">
            <h3 class="card-label">
              Danh Sách Dịch Vụ Khám
              <span class="d-block text-muted pt-2 font-size-sm"
                >Mã Lịch Hẹn Khám: {{ id_lich_hen }}</span
              >
              <span class="d-block text-muted pt-2 font-size-sm"
                >Tên Bệnh Nhân: {{ lich_hen.benh_nhan.ho_ten }}</span
              >
            </h3>
          </div>
          <div class="card-toolbar">
            <!--begin::Button-->
            <a
              href="{% url 'danh_sach_benh_nhan_cho' %}"
              class="btn btn-light-primary font-weight-bolder"
            >
              <span class="svg-icon svg-icon-md">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  width="24px"
                  height="24px"
                  viewBox="0 0 24 24"
                  version="1.1"
                >
                  <g
                    stroke="none"
                    stroke-width="1"
                    fill="none"
                    fill-rule="evenodd"
                  >
                    <polygon points="0 0 24 0 24 24 0 24" />
                    <rect
                      fill="#000000"
                      opacity="0.3"
                      transform="translate(12.000000, 12.000000) scale(-1, 1) rotate(-90.000000) translate(-12.000000, -12.000000) "
                      x="11"
                      y="5"
                      width="2"
                      height="14"
                      rx="1"
                    />
                    <path
                      d="M3.7071045,15.7071045 C3.3165802,16.0976288 2.68341522,16.0976288 2.29289093,15.7071045 C1.90236664,15.3165802 1.90236664,14.6834152 2.29289093,14.2928909 L8.29289093,8.29289093 C8.67146987,7.914312 9.28105631,7.90106637 9.67572234,8.26284357 L15.6757223,13.7628436 C16.0828413,14.136036 16.1103443,14.7686034 15.7371519,15.1757223 C15.3639594,15.5828413 14.7313921,15.6103443 14.3242731,15.2371519 L9.03007346,10.3841355 L3.7071045,15.7071045 Z"
                      fill="#000000"
                      fill-rule="nonzero"
                      transform="translate(9.000001, 11.999997) scale(-1, -1) rotate(90.000000) translate(-9.000001, -11.999997) "
                    />
                  </g>
                </svg>
              </span>
              Quay Lại
            </a>
            <!--end::Button-->
          </div>
        </div>
        <div class="card-body">
          <!--begin: Search Form-->
          <!--begin::Search Form-->
          <div class="mb-7">
            <div class="row align-items-center">
              <div class="col-lg-12 col-xl-9">
                <div class="row align-items-center">
                  <div class="col-md-6 my-2 my-md-0">
                    <div class="input-icon">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Tìm kiếm..."
                        id="kt_datatable_search_query_2"
                      />
                      <span>
                        <i class="flaticon2-search-1 text-muted"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--end::Search Form-->
          <!--begin: Selected Rows Group Action Form-->
          <div
            class="mt-10 mb-5 collapse"
            id="kt_datatable_group_action_form_2"
          >
            <div class="d-flex align-items-center">
              <div class="font-weight-bold text-success mr-3">
                Đã chọn <span id="kt_datatable_selected_records_2"></span> khoa
                khám!
              </div>
            </div>
          </div>
          <!--end: Selected Rows Group Action Form-->
          <!--begin: Datatable-->
          <div
            class="datatable datatable-bordered datatable-head-custom"
            id="kt_datatable_2"
          ></div>
          <!--end: Datatable-->
        </div>
      </div>
      <!--end::Card-->

      <!--begin::Card-->
      <div class="card card-custom mt-7">
        <div class="card-header">
          <div class="card-title">
            <h3 class="card-label">Bảng phân khoa</h3>
          </div>
        </div>
        <div class="card-body" id="tablePhanKhoa">
          <!--begin: Datatable-->
          <table
            class="table table-bordered table-hover table-checkable"
            id="kt_datatable_3"
            style="margin-top: 13px !important"
          >
            <thead>
              <tr>
                <td>ID</td>
                <td>Tên Dịch Vụ</td>
                <td>Phòng Chức Năng</td>
                <td>Bảo Hiểm</td>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <!--end: Datatable-->
        </div>

        <div id="divPrintPhanKhoa" style="display: none">
          {{ mau_hoa_don.noi_dung|safe }}
        </div>

        <div class="card-footer">
          <div class="card-toolbar text-right">
            <!--begin::Button-->
            <a
              href="javascript:;"
              id="printPhanKhoa"
              class="btn btn-light-primary font-weight-bolder"
            >
              <i class="la la-plus"></i>
              In DS Phân Khoa
            </a>
            <a
              href="javascript:;"
              class="btn btn-primary font-weight-bolder"
              id="get-table-data"
              data-id="{{ id_lich_hen }}"
              data-user-id="{{ lich_hen.benh_nhan.id }}"
            >
              <i class="la la-plus"></i>
              Phân khoa khám
            </a>

            <!--end::Button-->
          </div>
        </div>
      </div>
      <!--end::Card-->
    </div>
    <!-- end::Container -->
  </div>
  <!-- end::Entry -->
</div>
<!-- end::Content -->

{% endblock content %} {% block scripts %} 
<!--begin::Global Theme Bundle(used by all pages)-->

<!--end::Global Theme Bundle-->

<!--begin::Custom Javascripts(used by this page)-->
<script>

  "use strict";
  // Class definition

  function printDiv()
  {

    var divToPrint=document.getElementById('divPrintPhanKhoa');

    var newWin=window.open('','Print-Window');

    newWin.document.open();

    newWin.document.write('<html><body onload="window.print()">'+divToPrint.innerHTML+'</body></html>');

    newWin.document.close();

    setTimeout(function(){newWin.close();},10);

  }

  var KTDatatableRecordSelectionDemo = function() {
      // Private functions

      var phanKhoaHtml = ""
      var so_luong_dang_cho = ""

      var options = {
          // datasource definition
          data: {
              type: 'remote',
              source: {
                  read: {
                      url: HOST_URL + '/api/dich_vu_kham/',
                      method: 'GET',
                  },
              },
              pageSize: 5,
              serverPaging: true,
              serverFiltering: true,
              serverSorting: false,
              saveState: false,
          },

          // layout definition
          layout: {
              scroll: false, // enable/disable datatable scroll both horizontal and
              footer: false // display/hide footer
          },

          // column sorting
          sortable: true,

          pagination: true,

          // columns definition
          columns: [{
              field: 'id',
              title: '#',
              sortable: false,
              width: 20,
              selector: {
                  class: ''
              },
              textAlign: 'center',
          }, {
              field: 'ten_dvkt',
              title: 'Tên Dịch Vụ',
              sortable: false,
          }, {
              field: 'quyet_dinh',
              title: 'Quyết Định',
              sortable: false,
          }, {
              field: 'cong_bo',
              title: 'Công Bố',
              sortable: false,
          }, {
              field: 'bac_si_phu_trach.ho_ten',
              title: 'Bác Sĩ Phụ Trách',
              sortable: false,

          }, {
              field: 'phong_chuc_nang.ten_phong_chuc_nang',
              title: 'Phòng Chức Năng',
              textAlign: 'center',
              autoHide: false,
              sortable: false,
          }, {
              field: 'bao hiem',
              title: 'Dùng Bảo Hiểm',
              textAlign: 'center',
              autoHide: false,
              sortable: false,
              template: function(row){
                  if(row.bao_hiem == true){
                      return '<span class="label font-weight-bold label-lg label-light-primary label-inline">Có áp dụng</span>'
                  }else{
                      return '<span class="label font-weight-bold label-lg label-light-warning label-inline">Không áp dụng</span>'
                  }
              }
          }
          ],
      };

      var serverSelectorDemo = function() {
          // enable extension
          options.extensions = {
              // boolean or object (extension options)
              checkbox: true,
          };
          options.search = {
              input: $('#kt_datatable_search_query_2'),
              key: 'search',
          };

          var datatable = $('#kt_datatable_2').KTDatatable(options);

          $('#kt_datatable_search_status_2').on('change', function() {
              datatable.search($(this).val().toLowerCase(), 'Status');
          });

          $('#kt_datatable_search_type_2').on('change', function() {
              datatable.search($(this).val().toLowerCase(), 'Type');
          });

          $('#kt_datatable_search_status_2, #kt_datatable_search_type_2').selectpicker();

          datatable.on(
              'datatable-on-click-checkbox',
              function(e) {
                  var ids = datatable.checkbox().getSelectedId();
                  var count = ids.length;
                  $('#kt_datatable_selected_records_2').html(count);

                  if (count > 0) {
                      $('#kt_datatable_group_action_form_2').collapse('show');
                  } else {
                      $('#kt_datatable_group_action_form_2').collapse('hide');
                  }
              });

          var lstData = [];
          var lstCheckbox = {};
          var lstQuantity = {};
          var lstUsage = {};
          var lstNote = {};

          $('#get-table-data').on('click', function (){
              var id_lich_hen = $(this).data('id');
              var user_id     = $(this).data('user-id');
              getCheckbox();
              // getPostData(user_id);
              postData(user_id, id_lich_hen);
          })

          $('#printPhanKhoa').on('click', function() {
              var data_bac_si = ''
              var data_bac_si_chi_dinh = ''
              var bac_si_chi_dinh = "{{ bac_si_chi_dinh|safe }}"
              var data_so_dien_thoai = ''
              var data_dia_chi = ''
              var data_thoi_gian = ''
              var benh_nhan = "{{ benh_nhan|safe }}"
              var so_dien_thoai = "{{ so_dien_thoai|safe }}"
              var dia_chi = "{{ dia_chi|safe }}"
              var thoi_gian = "{{ thoi_gian|safe }}"

              $('#divPrintPhanKhoa tbody tr').each(function() {
                  if ($(this).find('td').eq(0).text() == '{ten_dich_vu}'){
                      $(this).replaceWith(phanKhoaHtml)
                  }

                  if($(this).find('td').eq(0).text() == '{bac_si_chi_dinh}'){
                      console.log($(this).html());
                      var innerHtml = $(this).html();
                      var start_tr = '<tr>';
                      var end_tr = '</tr>';
                      var c = start_tr + innerHtml + end_tr;

                      data_bac_si += c.replace(/{bac_si_chi_dinh}/, bac_si_chi_dinh).replace(/{benh_nhan}/, benh_nhan);

                      $(this).replaceWith(data_bac_si);
                  }

                  if($(this).find('td').eq(1).text() == '{so_dien_thoai}'){
                      console.log($(this).html())
                      var innerHtml = $(this).html()
                      var start_tr = '<tr>'
                      var end_tr = '</tr>'
                      var c = start_tr + innerHtml + end_tr

                      data_so_dien_thoai += c.replace(/{so_dien_thoai}/, so_dien_thoai)

                      $(this).replaceWith(data_so_dien_thoai)
                  }

                  if($(this).find('td').eq(1).text() == '{dia_chi}'){
                      console.log($(this).html())
                      var innerHtml = $(this).html()
                      var start_tr = '<tr>'
                      var end_tr = '</tr>'
                      var c = start_tr + innerHtml + end_tr

                      data_dia_chi += c.replace(/{dia_chi}/, dia_chi)

                      $(this).replaceWith(data_dia_chi)
                  }

                  if($(this).find('td').eq(1).text() == '{thoi_gian}'){
                      console.log($(this).html())
                      var innerHtml = $(this).html()
                      var start_tr = '<tr>'
                      var end_tr = '</tr>'
                      var c = start_tr + innerHtml + end_tr

                      data_thoi_gian += c.replace(/{thoi_gian}/, thoi_gian)

                      $(this).replaceWith(data_thoi_gian)
                  }

                  if($(this).find('td').eq(1).text() == '{bac_si_chi_dinh}'){
                      console.log($(this).html())
                      var innerHtml = $(this).html()
                      var start_tr = '<tr>'
                      var end_tr = '</tr>'
                      var c = start_tr + innerHtml + end_tr

                      data_bac_si_chi_dinh += c.replace(/{bac_si_chi_dinh}/, bac_si_chi_dinh)

                      $(this).replaceWith(data_bac_si_chi_dinh)
                  }

              })

              printDiv()
          })

          var get_funcroom_info = function(data) {
              $.ajax({
                  url: HOST_URL + "/api/funcroom_info/",
                  type: 'GET',  // http method
                  data: {'id': data.obj.id},
                  dataType: 'json',
                  success: function (response) {
                      phanKhoaHtml += `
                          <tr class="${data.obj.id}">
                              <td style="height:40px; width:400px">${data.obj.ten_dvkt}</td>
                              <td style="height:40px; width:250px">${data.obj.phong_chuc_nang.ten_phong_chuc_nang}</td>
                              <td style="height:40px; width:100px">${response.dang_cho}</td>
                          </tr>

                      `
                  },
                  error: function (jqXhr, textStatus, errorMessage) {
                      console.log('Error' + errorMessage);
                  }
              });
          }

          var replacePhanKhoaHtml = function(data) {
              $.ajax({
                  url: HOST_URL + "/api/funcroom_info/",
                  type: 'GET',  // http method
                  data: {'id': data.obj.id},
                  dataType: 'json',
                  success: function (response) {
                      phanKhoaHtml = phanKhoaHtml.replace(`
                          <tr class="${data.obj.id}">
                              <td style="height:40px; width:400px">${data.obj.ten_dvkt}</td>
                              <td style="height:40px; width:250px">${data.obj.phong_chuc_nang.ten_phong_chuc_nang}</td>
                              <td style="height:40px; width:100px">${response.dang_cho}</td>
                          </tr>

                      `, "")
                  },
                  error: function (jqXhr, textStatus, errorMessage) {
                      console.log('Error' + errorMessage);
                  }
              });
          }

          datatable.on('click', 'tbody input[type="checkbox"]', function () {
              $(this).toggleClass('selected');
              // console.log($(this).val())
              var objList = [];

              if($(this).is(":checked")){
                  var trVals = $(this).closest('tr').data();

                  lstData.push(trVals)

                  console.log(lstData)
                  get_funcroom_info(trVals)

                  $(trVals).each(function () {

                      $('#kt_datatable_3 tbody').append(`
                          <tr class="${trVals.obj.id}" data-id = "${trVals.obj.id}" name="true" data-checked="True" data-unchecked="False">
                              <td>
                              ${trVals.obj.ma_dvkt}
                              </td>
                              <td>
                              ${trVals.obj.ten_dvkt}
                              </td>
                              <td>
                              ${trVals.obj.phong_chuc_nang.ten_phong_chuc_nang}
                              </td>
                              {% comment %} <td>
                              ${trVals.obj.bac_si_phu_trach.ho_ten}
                              </td> {% endcomment %}
                              <td>
                                  <input type="checkbox" id="${trVals.obj.id}" class="big-checkbox" data-checked="True" data-unchecked="False">
                              </td>

                          </tr>
                      `);


                  })

              } else {
                  var trVals = $(this).closest('tr').data();
                  $(`.${trVals.obj.id}`).remove();
                  lstData = lstData.filter((item) => item!==trVals)
                  replacePhanKhoaHtml(trVals)
                  {% comment %} phanKhoaHtml = phanKhoaHtml.replace(`
                          <tr class="${trVals.obj.id}">
                              <td colspan="4" rowspan="1" style="border-bottom:1px solid black; border-left:1px solid black; border-right:1px solid black; border-top:1px solid black; height:28px; text-align:left; vertical-align:bottom; white-space:nowrap"><span style="color:#000000; font-family:Times New Roman, serif"><span style="font-size:16px">${trVals.obj.ten_dvkt}</span></span></td>
                              <td colspan="7" rowspan="1" style="border-bottom:1px solid black; border-left:none; border-right:1px solid black; border-top:1px solid black; text-align:center; vertical-align:bottom; white-space:nowrap"><span style="font-size:16px"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="color:black">${trVals.obj.phong_chuc_nang.ten_phong_chuc_nang}</span></span></span></td>
                              <td class="so-luong-dang-cho" colspan="7" rowspan="1" style="border-bottom:1px solid black; border-left:none; border-right:1px solid black; border-top:1px solid black; text-align:center; vertical-align:bottom; white-space:nowrap"><span style="font-size:16px"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="color:black">${so_luong_dang_cho}</span></span></span></td>
                          </tr>
                          `, "") {% endcomment %}

              }
          })

          $('#kt_datatable_3').on('click', 'tbody input[type="checkbox"]', function () {
              if($(this).is(":checked")){
                  lstCheckbox = {};
                  getCheckbox();
                  console.log(lstCheckbox);
              } else {
                  lstCheckbox = {};
                  getCheckbox();
                  console.log(lstCheckbox);
              }
          })

          function postData(user_id, id_lich_hen){
              var user_id = user_id
              var id_lich_hen = id_lich_hen

              console.log(id_lich_hen)
              var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

              function csrfSafeMethod(method) {
                  // these HTTP methods do not require CSRF protection
                  return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
              }

              $.ajaxSetup({
                  beforeSend: function(xhr, settings) {
                      function getCookie(name) {
                          var cookieValue = null;
                          if (document.cookie && document.cookie != '') {
                              var cookies = document.cookie.split(';');
                              for (var i = 0; i < cookies.length; i++) {
                                  var cookie = jQuery.trim(cookies[i]);
                                  // Does this cookie string begin with the name we want?
                                  if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                      break;
                                  }
                              }
                          }
                          return cookieValue;
                      }
                      if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                          // Only send the token to relative URLs i.e. locally.
                          xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                      }
                  }
              });

              $.ajax({
                  type: "POST",
                  url: "{% url 'store_phan_khoa' %}",
                  data: {
                      'data': JSON.stringify(getPostData(user_id)),
                      'csrfmiddlewaretoken': csrftoken,
                      'user': user_id,
                      'id_lich_hen' : id_lich_hen
                  },
                  dataType: 'json',
                  safe: false,
                  success: function(response) {
                      if (response.status == 200) {
                          toastr.success(response.message, "Thành Công")
                          setTimeout(function () {
                              window.location.href = response.url;
                          }, 2000);
                      } else if (response.status == 404) {
                          toastr.warning(response.message, "Lỗi")
                      }

                  },
                  error: function() {
                      toastr.warning("Phân Khoa Không Thành Công", "Lỗi")
                  }
              });
          }

          function getPostData(user_id, id_lich_hen){
              var user_id = user_id
              var id_lich_hen = id_lich_hen
              console.log(user_id)
              var rowData = lstData;
              var checkBoxObj = lstCheckbox;
              for (const each in checkBoxObj) {
                  for (let i = 0; i < rowData.length; i++) {
                      if (rowData[i].obj.id == each) {
                          rowData[i].obj.bao_hiem = checkBoxObj[each];
                          rowData[i].obj.benh_nhan = user_id;
                      }
                  }
              }
              console.log(rowData)
              return rowData;
          }

          function getCheckbox(){

              $('#kt_datatable_3 tbody tr').each(function() {

                  var sectionId = $(this).data('id');
                  console.log(sectionId)

                  $(this).find('input.big-checkbox:checked').each(function() {
                      console.log($(this).attr('data-checked'));
                      lstCheckbox[sectionId] = $(this).attr('data-checked');
                  });

                  $(this).find('input.big-checkbox:not(:checked)').each(function() {
                      lstCheckbox[sectionId] = $(this).attr('data-unchecked');
                  });
              });
          }

          $('#kt_datatable_fetch_modal_2').on('show.bs.modal', function(e) {
              var ids = datatable.checkbox().getSelectedId();

              var recordID = [];
              var c = document.createDocumentFragment();
              for (var i = 0; i < ids.length; i++) {
                  var li = document.createElement('li');
                  li.setAttribute('data-id', ids[i]);
                  li.innerHTML = 'Selected record ID: ' + ids[i];
                  c.appendChild(li);
              }

              $('#kt_datatable_fetch_display_2').append(c);
          }).on('hide.bs.modal', function(e) {
              $('#kt_datatable_fetch_display_2').empty();
          });


      };

      return {
          // public functions
          init: function() {
              serverSelectorDemo();
          },
      };
  }();

  jQuery(document).ready(function() {
      KTDatatableRecordSelectionDemo.init();
  });
</script>
<!--end::Custom Javascripts-->

{% endblock scripts %}
